OPT ?= -O2 -g2 -DNDEBUG      # (A) Production use (optimized mode)
#OPT ?= -O2 -g2 -DNDEBUG -funroll-all-loops
#OPT ?= -g2              # (B) Debug mode, w/ full line-level debugging symbols
#OPT ?= -O2 -fno-omit-frame-pointer -g2 -DNDEBUG # (C) Profiling mode: opt, but w/debugging symbols
#-----------------------------------------------

CC=gcc
CXX=g++

CHOP=$(strip $(C))

# detect what platform we're building on
$(shell CC=$(CC) CXX=$(CXX) TARGET_OS=$(TARGET_OS) CHOP=$(CHOP)\
    ./build_detect_platform build_config.mk ./)
# this file is generated by the previous line to set build flags and sources
include build_config.mk

TIANXI_LDFLAGS=-L/users/PES0781/frankli/install/gflags-2.2.1/lib -L/users/PES0781/frankli/install/glog-0.3.5/lib -lgflags -lglog
TIANXI_FLAGS=-I/users/PES0781/frankli/install/cppzmq-4.5.0/include -I/users/PES0781/frankli/install/gflags-2.2.1/include -I/users/PES0781/frankli/install/glog-0.3.5/include

CFLAGS += -I. -I./include $(PLATFORM_CCFLAGS) $(OPT) $(TIANXI_FLAGS) $(TIANXI_LDFLAGS)
CXXFLAGS += -I. -I./include $(PLATFORM_CXXFLAGS) $(OPT)  -std=c++0x $(TIANXI_FLAGS) $(TIANXI_LDFLAGS)

LDFLAGS += $(PLATFORM_LDFLAGS) $(TIANXI_LDFLAGS)
LIBS += $(PLATFORM_LIBS)

LIBOBJECTS = $(SOURCES:.cc=.o)
MEMENVOBJECTS = $(MEMENV_SOURCES:.cc=.o)

LIBOBJECTS += util/timestamp.o extra.o

LIBRARY = libleveldb.a
MEMENVLIBRARY = libmemenv.a

default: all

all: $(SHARED) $(LIBRARY)

clean:
	-rm -f $(PROGRAMS) $(BENCHMARKS) $(LIBRARY) $(SHARED) $(MEMENVLIBRARY) */*.o */*/*.o ios-x86/*/*.o ios-arm/*/*.o build_config.mk
	-rm -rf ios-x86/* ios-arm/*
	-rm -rf util/timestamp
	-rm -rf extra.o

$(LIBRARY): $(LIBOBJECTS)
	rm -f $@
	$(AR) -rs $@ $(LIBOBJECTS)

dbtest: oltp/dbtest.o $(LIBOBJECTS) $(TESTUTIL)
	$(CXX) $(LDFLAGS) oltp/dbtest.o $(LIBOBJECTS) $(TESTUTIL) -o $@ $(LIBS)

extra.o:
	@$(CXX) $(CXXFLAGS) $(CPPFLAGS) extra.cpp -c -o $@

.PHONY: util/timestamp.o

util/timestamp.o:
	@mkdir -p util/
	@rm -f util/timestamp.cpp
	@echo -n "const char* MakefileTimestampSignature=\"" >> util/timestamp.cpp
	@echo -n Compiled on `date`,\  >> util/timestamp.cpp
	@echo -n git HEAD is `git rev-parse HEAD`,\  >> util/timestamp.cpp
	@echo -n using CXX=$(CXX),\  >> util/timestamp.cpp
	@echo -n CXXFLAGS=$(CXXFLAGS),\  >> util/timestamp.cpp
	@echo -n CPPFLAGS=$(CPPFLAGS),\  >> util/timestamp.cpp
	@echo -n LDFLAGS=$(LDFLAGS),\  >> util/timestamp.cpp
	@echo -n and LDLIBS=$(LDLIBS).\  >> util/timestamp.cpp
	@echo -n Compiler version is:\ >> util/timestamp.cpp
	@$(CXX) --version | head -1 | tr -d \\n >> util/timestamp.cpp
	@echo -n .\  >> util/timestamp.cpp
	@$(CXX) -Q --help=target | tr \\n \; | tr \\t \  | tr -s \  >> util/timestamp
	@echo "\";" >> util/timestamp.cpp
	@$(CXX) $(CXXFLAGS) $(CPPFLAGS) util/timestamp.cpp -c -o $@
	@rm -f util/timestamp.cpp
